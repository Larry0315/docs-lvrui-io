<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"docs.lvrui.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="极地瑞雪的个人技术博客. &quot;取之开源 用之开源&quot;, 分享自己的经验之谈&quot;.">
<meta property="og:type" content="website">
<meta property="og:title" content="Polar Snow Documentation">
<meta property="og:url" content="https://docs.lvrui.io/page/18/index.html">
<meta property="og:site_name" content="Polar Snow Documentation">
<meta property="og:description" content="极地瑞雪的个人技术博客. &quot;取之开源 用之开源&quot;, 分享自己的经验之谈&quot;.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="极地瑞雪">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="etcd">
<meta property="article:tag" content="golang">
<meta property="article:tag" content="python">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://docs.lvrui.io/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Polar Snow Documentation</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?963aa068438aaf077b5ce5d3b8d51c95";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Polar Snow Documentation</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">花有重开日 人无再少年</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">379</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">288</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/Larry0315" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/09/09/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB%E8%87%B3ESXi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/09/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB%E8%87%B3ESXi/" class="post-title-link" itemprop="url">kvm虚拟机迁移至ESXi</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-09 14:37:55" itemprop="dateCreated datePublished" datetime="2016-09-09T14:37:55+08:00">2016-09-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/09/09/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB%E8%87%B3ESXi/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/09/kvm虚拟机迁移至ESXi/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="转换步骤"><a href="#转换步骤" class="headerlink" title="转换步骤"></a>转换步骤</h1><ul>
<li>将kvm中要迁移的虚拟机关机</li>
<li>找到该虚拟机对应的<code>.img</code>文件</li>
<li>使用<code>qemu-img convert</code>命令将img文件转换为<code>vmdk</code>文件</li>
<li>把<code>vmdk</code>文件传送到<code>ESXi</code>主机上</li>
<li>在<code>vCenter</code>中创建一个配置相同的主机，加载已存在的<code>vmdk</code>硬盘文件</li>
<li>开启虚拟机即可</li>
</ul>
<h1 id="qemu-img命令的时候用"><a href="#qemu-img命令的时候用" class="headerlink" title="qemu-img命令的时候用"></a>qemu-img命令的时候用</h1><p><code>qemu-img</code>命​令​行​工​具​是​<code>Xen</code>和​<code>KVM</code>用​来​格​式​化​各​种​文​件​系​统​的​，可​使​用​<code>qemu-img</code>格​式​化​虚​拟​客​户​端​映​像​、​附​加​存​储​设​备​以​及​网​络​存​储​。还可以用来转换镜像文件</p>
<h2 id="创建磁盘文件"><a href="#创建磁盘文件" class="headerlink" title="创建磁盘文件"></a>创建磁盘文件</h2><p><strong>创​建​新​磁​盘​映​像​文​件​名​为​ sina_kvm，格​式​为​ format</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create [-6] [-e] [-b base_image] [-f format] filename [sina_kvm]</span><br></pre></td></tr></table></figure>

<p>例如：创建一个10M的镜像文件：ps_kvm.img，文件格式为：raw</p>
<h2 id="转换镜像格式"><a href="#转换镜像格式" class="headerlink" title="转换镜像格式"></a>转换镜像格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert [-c] [-e] [-f format] filename [-O output_format] output_filename</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert 10-71-hadoop.shennong.ren.img -O vmdk /tmp/testhdp.vmdk</span><br></pre></td></tr></table></figure>

<h2 id="获取镜像信息"><a href="#获取镜像信息" class="headerlink" title="获取镜像信息"></a>获取镜像信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img info [-f format] filename</span><br></pre></td></tr></table></figure>

<h2 id="支持的格式"><a href="#支持的格式" class="headerlink" title="支持的格式"></a>支持的格式</h2><p>映​像​格​式​通​常​是​自​动​获​取​的​。​支​持​以​下​格​式​：</p>
<ul>
<li>raw</li>
</ul>
<p>Raw 磁​盘​映​像​格​式​（默​认​）。​这​个​格​式​的​优​点​是​可​以​简​单​、​容​易​地​导​出​到​其​它​模​拟​器​中​。​如​果​您​的​文​件​系​统​支​持​中​断​（例​如​在​ Linux 中​的​ ext2 或​者​ ext3 以​及​ Windows 中​的​ NTFS），那​么​只​有​写​入​的​字​段​会​占​用​空​间​。​使​用​ qemu-img info 了​解​ Unix/Linux 中​映​像​或​者​ ls -ls 使​用​的​实​际​大​小​。​</p>
<ul>
<li>qcow2</li>
</ul>
<p>QEMU 映​像​格​式​，最​万​能​的​格​式​。​使​用​它​可​获​得​较​小​映​像​（如​果​您​的​系​统​不​支​持​中​断​，例​如​在​ Windows 中​，它​会​很​有​用​）、​额​外​的​ AES 加​密​法​、​zlib 压​缩​以​及​对​多​ VM 快​照​的​支​持​。​目前也是虚拟池一直在使用的镜像格式。<br>例如：<br>转换之前，原镜像disk size大小为8G，转换后仅仅只有2.3G。</p>
<ul>
<li>qcow</li>
</ul>
<p>旧​的​ QEMU 映​像​格​式​。​只​用​于​与​旧​版​本​兼​容​，目前虚拟池已无该格式镜像文件。​</p>
<ul>
<li>cow</li>
</ul>
<p>写​入​映​像​格​式​的​用​户​模​式​ Linux 副​本​。​包​含​ cow 格​式​的​目​的​只​是​为​了​与​前​面​的​版​本​兼​容​。​它​无​法​在​ Windows 中​使​用​，虚拟池已无该格式镜像文件。</p>
<ul>
<li>vmdk</li>
</ul>
<p>VMware 3 和​ 4 兼​容​映​像​格​式，虚拟池无该格式镜像文件​。​</p>
<ul>
<li>cloop</li>
</ul>
<p>Linux 压​缩​回​送​映​像​，只​有​在​重​复​使​用​直​接​压​缩​的​ CD-ROM 映​像​时​有​用​，比​如​在​ Knoppix CD-ROM 中​。</p>
<hr>
<p><em>参考文章</em></p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_502c8cc40101352g.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_502c8cc40101352g.html</a></li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/09/09/Linux%E8%BF%9E%E6%8E%A5PPTP%E5%8D%8F%E8%AE%AE%E7%9A%84VPN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/09/Linux%E8%BF%9E%E6%8E%A5PPTP%E5%8D%8F%E8%AE%AE%E7%9A%84VPN/" class="post-title-link" itemprop="url">Linux连接PPTP协议的VPN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-09 11:15:51" itemprop="dateCreated datePublished" datetime="2016-09-09T11:15:51+08:00">2016-09-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/09/09/Linux%E8%BF%9E%E6%8E%A5PPTP%E5%8D%8F%E8%AE%AE%E7%9A%84VPN/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/09/Linux连接PPTP协议的VPN/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ppp pptp pptp-setup</span><br></pre></td></tr></table></figure>

<h1 id="创建VPN连接"><a href="#创建VPN连接" class="headerlink" title="创建VPN连接"></a>创建VPN连接</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pptpsetup  --create vpnname --server x.x.x.x  --username uaername --password XXXXXX --encrypt --start</span><br></pre></td></tr></table></figure>

<ul>
<li>create是创建的连接名称</li>
<li>server是vpn的ip地址</li>
<li>username是用户名</li>
<li>password是密码，也可以没这个参数，命令稍后会自动询问。这样可以保证账号安全</li>
<li>encrypt 是表示需要加密，不必指定加密方式，命令会读取配置文件中的加密方式（默认使用require-mppe-128加密）</li>
<li>start是表示创建连接完后马上连接</li>
</ul>
<h1 id="连接已有的VPN配置"><a href="#连接已有的VPN配置" class="headerlink" title="连接已有的VPN配置"></a>连接已有的VPN配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pon vpnname</span><br></pre></td></tr></table></figure>

<p>这个命令在系统中bin目录中找不到，在pptd的安装目录下的script目录下，如果不清楚这个命令具体在哪里的可以执行以下命令查找</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">"poff"</span> -<span class="built_in">type</span> f</span><br></pre></td></tr></table></figure>

<p>我使用yum安装的软件，可以参考去以下路径查找</p>
<p><code>/usr/share/doc/ppp-2.4.5/scripts/</code></p>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p>连接成功后会在本地创建一个虚拟网口<code>ppp0</code></p>
<p>相关的路由也会加在路由表中，可以通过<code>route -n</code>和<code>ifconfig</code>命令查看</p>
<p>VPN连通后，可以指定本地所有流量都走VPN，也可以指定某几个网段的流量走VPN</p>
<ul>
<li>所有流量都走VPN，设置为默认路由</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">route add -net 0.0.0.0 dev ppp0</span><br><span class="line">或</span><br><span class="line">route add default dev ppp0</span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">route del -net 0.0.0.0 dev ppp0</span><br><span class="line">或</span><br><span class="line">route del default</span><br></pre></td></tr></table></figure>

<ul>
<li>指定网段的流量走VPN</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -net 192.168.168.0/24 dev ppp0</span><br></pre></td></tr></table></figure>

<p><strong>注意：重启网卡也会清除VPN通道</strong></p>
<h1 id="关闭VPN通道"><a href="#关闭VPN通道" class="headerlink" title="关闭VPN通道"></a>关闭VPN通道</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poff vpnname (全部下线poff -a)</span><br></pre></td></tr></table></figure>

<p>这个命令在系统中bin目录中找不到，在pptd的安装目录下的script目录下，如果不清楚这个命令具体在哪里的可以执行以下命令查找</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">"poff"</span> -<span class="built_in">type</span> f</span><br></pre></td></tr></table></figure>

<p>我使用yum安装的软件，可以参考去以下路径查找</p>
<p><code>/usr/share/doc/ppp-2.4.5/scripts/</code></p>
<h1 id="相关目录"><a href="#相关目录" class="headerlink" title="相关目录"></a>相关目录</h1><ul>
<li>/etc/ppp/peers/  存放用户创建的vpnname配置文件的地方</li>
<li>/etc/ppp/chap-secrets  用户名密码存放的地方（明文的）</li>
</ul>
<h1 id="注"><a href="#注" class="headerlink" title="注"></a>注</h1><ul>
<li>注1： pon 和 poff命令可在ppp源码目录下的scripts目录中找到。</li>
<li>注2： 要想使用vpn通道，需要根据需要在本地添加静态路由</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/09/09/%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4%E8%B7%AF%E7%94%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/09/%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4%E8%B7%AF%E7%94%B1/" class="post-title-link" itemprop="url">添加/删除路由</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-09 11:09:16" itemprop="dateCreated datePublished" datetime="2016-09-09T11:09:16+08:00">2016-09-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/09/09/%E6%B7%BB%E5%8A%A0-%E5%88%A0%E9%99%A4%E8%B7%AF%E7%94%B1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/09/添加-删除路由/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="查看路由"><a href="#查看路由" class="headerlink" title="查看路由"></a>查看路由</h1><h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.3.1     0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">192.168.3.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure>

<h2 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&gt; netstat -nr</span><br><span class="line">Routing tables</span><br><span class="line"></span><br><span class="line">Internet:</span><br><span class="line">Destination        Gateway            Flags        Refs      Use   Netif Expire</span><br><span class="line">default            10.1.101.254       UGSc          214      718     en0</span><br><span class="line">10.1.100/23        link<span class="comment">#4             UCS            11        0     en0</span></span><br><span class="line">10.1.100.22        link<span class="comment">#4             UHLWIi          1        1     en0</span></span><br><span class="line">10.1.100.65/32     link<span class="comment">#4             UCS             2        0     en0</span></span><br><span class="line">10.1.100.65        60:3:8:a5:3b:9e    UHLWIi          1        3     lo0</span><br><span class="line">10.1.100.88        link<span class="comment">#4             UHLWIi          1        3     en0</span></span><br><span class="line">10.1.100.94        link<span class="comment">#4             UHLWIi          1        2     en0</span></span><br><span class="line">10.1.100.99        link<span class="comment">#4             UHLWIi          1        3     en0</span></span><br><span class="line">10.1.100.100       link<span class="comment">#4             UHLWIi          1        3     en0</span></span><br><span class="line">10.1.100.121       link<span class="comment">#4             UHLWIi          1        3     en0</span></span><br><span class="line">10.1.100.146       90:b6:86:d8:d:24   UHLWIi          1        1     en0    867</span><br><span class="line">10.1.101.128       link<span class="comment">#4             UHLWIi          1        2     en0</span></span><br><span class="line">10.1.101.164       c8:25:e1:61:70:2e  UHLWIi          1        1     en0   1004</span><br><span class="line">10.1.101.254/32    link<span class="comment">#4             UCS             2        0     en0</span></span><br><span class="line">10.1.101.254       b0:aa:77:1a:b0:58  UHLWIir       215       16     en0    782</span><br><span class="line">10.1.101.255       link<span class="comment">#4             UHLWbI          1      142     en0</span></span><br><span class="line">10.255.1/24        10.255.1.65        UGSc            1        0   utun0</span><br><span class="line">10.255.1.65        10.255.1.66        UH              3        0   utun0</span><br><span class="line">10.255.99/24       10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">10.255.99.49       10.255.99.50       UH             13        0   utun1</span><br><span class="line">10.255.100/24      10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">10.255.100.41      10.255.100.42      UH             13        0   utun2</span><br><span class="line">111.202.124.222/32 192.168.1.1        UGSc            2        0     en0</span><br><span class="line">127                127.0.0.1          UCS             1        0     lo0</span><br><span class="line">127.0.0.1          127.0.0.1          UH             27    57535     lo0</span><br><span class="line">169.254            link<span class="comment">#4             UCS             1        0     en0</span></span><br><span class="line">192.168.2          10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.3          10.255.99.49       UGSc            2        0   utun1</span><br><span class="line">192.168.4          10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.7          10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.8          10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.89         10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.90         10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.91         10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.95         10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.99         10.255.99.49       UGSc            1        0   utun1</span><br><span class="line">192.168.101        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.103        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.105        10.255.100.41      UGSc            2        0   utun2</span><br><span class="line">192.168.110        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.111        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.168        10.255.1.65        UGSc            1        0   utun0</span><br><span class="line">192.168.247        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.248        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.251        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.252        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">192.168.253        10.255.100.41      UGSc            1        0   utun2</span><br><span class="line">224.0.0            link<span class="comment">#4             UmCS            2        0     en0</span></span><br><span class="line">224.0.0.251        1:0:5e:0:0:fb      UHmLWI          1        0     en0</span><br><span class="line">255.255.255.255/32 link<span class="comment">#4             UCS             2        0     en0</span></span><br><span class="line">255.255.255.255    link<span class="comment">#4             UHLWbI          1      133     en0</span></span><br></pre></td></tr></table></figure>

<h1 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h1><h2 id="通过出口IP添加"><a href="#通过出口IP添加" class="headerlink" title="通过出口IP添加"></a>通过出口IP添加</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">route add -net 192.168.2.0/24 gw 192.168.10.85</span><br><span class="line">route add -net 192.168.8.0/24 gw 192.168.10.85</span><br><span class="line">route add -net 192.168.168.0/24 gw 192.168.10.85</span><br><span class="line">route add -net 192.168.100.0/24 gw 192.168.10.85</span><br></pre></td></tr></table></figure>

<h2 id="通过出口设备添加"><a href="#通过出口设备添加" class="headerlink" title="通过出口设备添加"></a>通过出口设备添加</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -net 0.0.0.0 dev ppp0 //添加默认路由</span><br></pre></td></tr></table></figure>

<h1 id="删除路由"><a href="#删除路由" class="headerlink" title="删除路由"></a>删除路由</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">route del -net 192.168.2.0&#x2F;24 gw 192.168.10.85</span><br><span class="line">route del -net 192.168.8.0&#x2F;24 gw 192.168.10.85</span><br><span class="line">route del -net 192.168.168.0&#x2F;24 gw 192.168.10.85</span><br><span class="line">route del -net 192.168.100.0&#x2F;24 gw 192.168.10.85</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/09/09/cisco%E8%AE%BE%E5%A4%87%E7%9A%84ping%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/09/cisco%E8%AE%BE%E5%A4%87%E7%9A%84ping%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">cisco设备的ping命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-09 10:57:24" itemprop="dateCreated datePublished" datetime="2016-09-09T10:57:24+08:00">2016-09-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/09/09/cisco%E8%AE%BE%E5%A4%87%E7%9A%84ping%E5%91%BD%E4%BB%A4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/09/cisco设备的ping命令/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用<code>ping x.x.x.x</code>命令默认发送5个包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ciscoasa&gt; ping 111.202.124.217</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 111.202.124.217, timeout is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;2&#x2F;10 ms</span><br></pre></td></tr></table></figure>

<p>可以指定发包的个数<code>ping x.x.x.x repeat num</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ciscoasa&gt; ping 111.202.124.217 repeat 100</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 100, 100-byte ICMP Echos to 111.202.124.217, timeout is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">Success rate is 100 percent (100&#x2F;100), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;3&#x2F;10 ms</span><br><span class="line">ciscoasa&gt; ping 111.202.124.217 repeat 1000</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 1000, 100-byte ICMP Echos to 111.202.124.217, timeout is 2 seconds:</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!?!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!?!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!?!?!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!?!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!?!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!?!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!?!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">Success rate is 99 percent (992&#x2F;1000), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;3&#x2F;30 ms</span><br></pre></td></tr></table></figure>

<p><strong>后面还可给<code>size</code> 指定数据包的大小；<code>timeout</code> 表示超时的时间</strong></p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/09/01/MySQL%E5%90%8C%E6%AD%A5%E6%8A%A5%E9%94%99-Last-IO-Error-Got-fatal-error-1236-from-master/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/01/MySQL%E5%90%8C%E6%AD%A5%E6%8A%A5%E9%94%99-Last-IO-Error-Got-fatal-error-1236-from-master/" class="post-title-link" itemprop="url">MySQL同步报错:Last_IO_Error: Got fatal error 1236 from master</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-01 11:06:46" itemprop="dateCreated datePublished" datetime="2016-09-01T11:06:46+08:00">2016-09-01</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/09/01/MySQL%E5%90%8C%E6%AD%A5%E6%8A%A5%E9%94%99-Last-IO-Error-Got-fatal-error-1236-from-master/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/01/MySQL同步报错-Last-IO-Error-Got-fatal-error-1236-from-master/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>配置MySQL从库，启动slave线程后”Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: ‘Could not find first log file name in binary log index file”的错误❌ </p>
</blockquote>
<ul>
<li>step 1</li>
</ul>
<p>先到slave中停止同步线程</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  stop slave for channel "db136";  # mysql5.7多源复制的语法</span><br></pre></td></tr></table></figure>

<ul>
<li>step 2</li>
</ul>
<p>回到master中，关闭当前的二进制日志文件并创建一个新文件，新的二进制日志文件的名字在当前的二进制文件的编号上加1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line">| mysql-bin.000038 |      154 |              | mysql            |                   |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>step 3</li>
</ul>
<p>再从slave执行change master</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host="192.168.1.136", master_port=3306, master_user="repl",master_password="12345678",master_log_file="mysql-bin.000038",master_log_pos=154 for channel "db136";</span><br><span class="line">mysql&gt; start slave for channel "db136";</span><br><span class="line">mysql&gt; show slave status for channel "db136";</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/08/21/MySQL5-7%E5%A2%9E%E5%BC%BA%E7%89%88%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/21/MySQL5-7%E5%A2%9E%E5%BC%BA%E7%89%88%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">MySQL5.7增强版的多线程主从复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-21 15:52:40" itemprop="dateCreated datePublished" datetime="2016-08-21T15:52:40+08:00">2016-08-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/21/MySQL5-7%E5%A2%9E%E5%BC%BA%E7%89%88%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/MySQL5-7增强版的多线程主从复制/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>MySQL多线程主从复制不是5.7版本中的新鲜产物，这个特性在5.6版本中就已经提供。但是在5.7版本中给多线程主从复制的特性做了增强</p>
</blockquote>
<ul>
<li>在MySQL5.6版本中的多线程复制，前提是一个线程只针对一个库</li>
<li>在MySQL5.7版本中，一个库可以使用多个线程同步，可以认为MySQL5.7的多线程复制是基于表的</li>
</ul>
<h1 id="多线程复制的配置"><a href="#多线程复制的配置" class="headerlink" title="多线程复制的配置"></a>多线程复制的配置</h1><p>根据MySQL复制原理，可以知道，多线程复制只需要修改slave端即可</p>
<h2 id="检查系统当前多线程复制的参数"><a href="#检查系统当前多线程复制的参数" class="headerlink" title="检查系统当前多线程复制的参数"></a>检查系统当前多线程复制的参数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'slave_parallel%';</span><br><span class="line">+<span class="comment">------------------------+----------+</span></span><br><span class="line">| Variable_name          | Value    |</span><br><span class="line">+<span class="comment">------------------------+----------+</span></span><br><span class="line">| slave_parallel_type    | DATABASE |</span><br><span class="line">| slave_parallel_workers | 0        |</span><br><span class="line">+<span class="comment">------------------------+----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>从上面的查询结果上来看，slave默认的多线程复制类型是基于数据库的，也就是一个数据库对应一个线程；而多线程复制的线程数量为0，意为单进程复制</p>
<h2 id="设置多线程复制"><a href="#设置多线程复制" class="headerlink" title="设置多线程复制"></a>设置多线程复制</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global slave_parallel_type='logical_clock';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global slave_parallel_workers=8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.18 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h2 id="查看复制线程"><a href="#查看复制线程" class="headerlink" title="查看复制线程"></a>查看复制线程</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br><span class="line">+<span class="comment">----+-----------------+-----------+------+---------+--------+--------------------------------------------------------+------------------+</span></span><br><span class="line">| Id | User            | Host      | db   | Command | Time   | State                                                  | Info             |</span><br><span class="line">+<span class="comment">----+-----------------+-----------+------+---------+--------+--------------------------------------------------------+------------------+</span></span><br><span class="line">|  1 | event_scheduler | localhost | NULL | Daemon  | 141366 | Waiting on empty queue                                 | NULL             |</span><br><span class="line">| 13 | root            | localhost | NULL | Query   |      0 | starting                                               | <span class="keyword">show</span> <span class="keyword">processlist</span> |</span><br><span class="line">| <span class="number">14</span> | <span class="keyword">system</span> <span class="keyword">user</span>     |           | <span class="literal">NULL</span> | <span class="keyword">Connect</span> |     <span class="number">49</span> | Waiting <span class="keyword">for</span> <span class="keyword">master</span> <span class="keyword">to</span> send <span class="keyword">event</span>                       | <span class="literal">NULL</span>             |</span><br><span class="line">| <span class="number">15</span> | <span class="keyword">system</span> <span class="keyword">user</span>     |           | <span class="literal">NULL</span> | <span class="keyword">Connect</span> |     <span class="number">48</span> | <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates | NULL             |</span><br><span class="line">| 16 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 17 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 18 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 19 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 20 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 21 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 22 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">| 23 | system user     |           | NULL | Connect |     49 | Waiting for an event from Coordinator                  | NULL             |</span><br><span class="line">+<span class="comment">----+-----------------+-----------+------+---------+--------+--------------------------------------------------------+------------------+</span></span><br><span class="line">12 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'slave_parallel%'</span>;</span><br><span class="line">+<span class="comment">------------------------+---------------+</span></span><br><span class="line">| Variable_name          | Value         |</span><br><span class="line">+<span class="comment">------------------------+---------------+</span></span><br><span class="line">| slave_parallel_type    | LOGICAL_CLOCK |</span><br><span class="line">| slave_parallel_workers | 8             |</span><br><span class="line">+<span class="comment">------------------------+---------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p><em>注：MySQL5.7支持多源复制，这里的多线程复制的意思是为每一个源分配的多线程。例如上面我设置了线程数量为8，那意为着每个channel复制源都会提供8个线程去复制，如果有两个channel，那么在processlist中将看到16个线程</em></p>
<h2 id="查看多线程复制相关的视图"><a href="#查看多线程复制相关的视图" class="headerlink" title="查看多线程复制相关的视图"></a>查看多线程复制相关的视图</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables like 'replication%';</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| Tables_in_performance_schema (replication%) |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">| replication_applier_configuration           |</span><br><span class="line">| replication_applier_status                  |</span><br><span class="line">| replication_applier_status_by_coordinator   |</span><br><span class="line">| replication_applier_status_by_worker        |</span><br><span class="line">| replication_connection_configuration        |</span><br><span class="line">| replication_connection_status               |</span><br><span class="line">| replication_group_member_stats              |</span><br><span class="line">| replication_group_members                   |</span><br><span class="line">+<span class="comment">---------------------------------------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from replication_applier_status_by_coordinator;</span><br><span class="line">+<span class="comment">--------------+-----------+---------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">| CHANNEL_NAME | THREAD_ID | SERVICE_STATE | LAST_ERROR_NUMBER | LAST_ERROR_MESSAGE | LAST_ERROR_TIMESTAMP |</span><br><span class="line">+<span class="comment">--------------+-----------+---------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">| db153        |        40 | ON            |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">+<span class="comment">--------------+-----------+---------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p><em>注：由于MySQL5.7支持多源复制，那么这个复制的协调者<code>replication_applier_status_by_coordinator</code>会去协调每一个channel的复制线程</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from replication_applier_status_by_worker;</span><br><span class="line">+<span class="comment">--------------+-----------+-----------+---------------+-----------------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">| CHANNEL_NAME | WORKER_ID | THREAD_ID | SERVICE_STATE | LAST_SEEN_TRANSACTION | LAST_ERROR_NUMBER | LAST_ERROR_MESSAGE | LAST_ERROR_TIMESTAMP |</span><br><span class="line">+<span class="comment">--------------+-----------+-----------+---------------+-----------------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">| db153        |         1 |        41 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         2 |        42 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         3 |        43 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         4 |        44 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         5 |        45 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         6 |        46 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         7 |        47 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">| db153        |         8 |        48 | ON            |                       |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">+<span class="comment">--------------+-----------+-----------+---------------+-----------------------+-------------------+--------------------+----------------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>在这里可以清楚的看到，为<code>db153</code>这一个channel提供了8个复制线程，如果有两个channel的，这里将显示16行</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/08/21/MySQL5-7%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/21/MySQL5-7%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/" class="post-title-link" itemprop="url">MySQL5.7的新特性(持续更新)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-21 15:17:00" itemprop="dateCreated datePublished" datetime="2016-08-21T15:17:00+08:00">2016-08-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/21/MySQL5-7%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/MySQL5-7的新特性-持续更新/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>MySQL5.7正式版本已经发布，在MySQL5.7中迎来了大幅的性能升级以及新的特性，本篇文章就来详细讨论下MySQL5.7的最新特性</p>
</blockquote>
<h1 id="MySQL服务功能增强"><a href="#MySQL服务功能增强" class="headerlink" title="MySQL服务功能增强"></a>MySQL服务功能增强</h1><h2 id="数据库初始化的方式变更"><a href="#数据库初始化的方式变更" class="headerlink" title="数据库初始化的方式变更"></a>数据库初始化的方式变更</h2><ul>
<li>在MySQL5.7版本之前，使用编译安装或使用二进制包部署MySQL，初始化的时候是使用了如下脚本来实现的</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; /<span class="variable">$path2mysql</span>/script/mysql_install_db \</span><br><span class="line">	--datadir=/data/mysql \</span><br><span class="line">	--user=mysql</span><br><span class="line">	--basedir=/<span class="variable">$path2mysql</span></span><br></pre></td></tr></table></figure>

<ul>
<li>到了MySQL5.7，不再提供脚本的方式初始化数据库，而是改用mysqld程序的命令来实现</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; mysqld --initialize --user=mysql \</span><br><span class="line">	--basedir=/<span class="variable">$path2mysql</span></span><br><span class="line">	--datadir=/data/mysql</span><br></pre></td></tr></table></figure>

<p>当然如果你使用了yum的方式安装了MySQL5.7，那么在第一次启动mysql的时候<code>systemctl start mysqld</code>默认会自动根据配置文件去初始化你的数据库</p>
<h2 id="支持为表增加计算列"><a href="#支持为表增加计算列" class="headerlink" title="支持为表增加计算列"></a>支持为表增加计算列</h2><p>什么是计算列？</p>
<p>当一张表上的某一列的数据是由其他列的值计算得到的列，就称之为计算列</p>
<p>例如：一张表t，有c1，c2和c3列，c3的值=c1+c2</p>
<ul>
<li>在MySQL5.7之前，计算列只能通过触发器的方式来实现</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t(id int auto_increment not null, c1 int, c2 int, c3 int, primary key (id));</span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>这张表建立之后，向t表中的c1和c2插入数据，c3是不可能自动计算出来的</p>
<p>只能通过插入触发器来实现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create trigger inst_t before insert on t for each row set new.c3=new.c1+new.c2; </span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show triggers;</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line">| Trigger | Event  | Table | Statement                | Timing | Created                | sql_mode                                                                                                                                  | Definer        | character_set_client | collation_connection | Database Collation |</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line">| inst_t  | <span class="keyword">INSERT</span> | t     | <span class="keyword">set</span> new.c3=new.c1+new.c2 | <span class="keyword">BEFORE</span> | <span class="number">2016</span><span class="number">-08</span><span class="number">-21</span> <span class="number">01</span>:<span class="number">52</span>:<span class="number">06.01</span> | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">insert</span> <span class="keyword">into</span> t(c1, c2) <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">Query OK, 1 row affected (0.11 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t;</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">|  1 |    1 |    2 |    3 |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>上面实现了插入触发器，测试正常，但是一旦我去更改c1或c2的值，c3列是不会跟着变更的</p>
<p>因此还需要建立一个更新触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create trigger upd_t before update on t for each row set new.c3=new.c1+new.c2;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show triggers;</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line">| Trigger | Event  | Table | Statement                | Timing | Created                | sql_mode                                                                                                                                  | Definer        | character_set_client | collation_connection | Database Collation |</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line">| inst_t  | <span class="keyword">INSERT</span> | t     | <span class="keyword">set</span> new.c3=new.c1+new.c2 | <span class="keyword">BEFORE</span> | <span class="number">2016</span><span class="number">-08</span><span class="number">-21</span> <span class="number">01</span>:<span class="number">52</span>:<span class="number">06.01</span> | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8mb4_unicode_ci |</span><br><span class="line">| upd_t   | <span class="keyword">UPDATE</span> | t     | <span class="keyword">set</span> new.c3=new.c1+new.c2 | <span class="keyword">BEFORE</span> | <span class="number">2016</span><span class="number">-08</span><span class="number">-21</span> <span class="number">02</span>:<span class="number">01</span>:<span class="number">50.46</span> | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">---------+--------+-------+--------------------------+--------+------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">update</span> t <span class="keyword">set</span> c1=<span class="number">5</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t;</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">|  1 |    5 |    2 |    7 |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>从上面的Demo可以看出，在MySQL5.7之前，如果想实现计算列，只少要创建插入和更新两个触发器</p>
<p>而使用视图也是可以实现计算列的目的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create view vw_t as select id,c1,c2,c1+c2 as c3 from t;</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from vw_t;</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">|  1 |    5 |    2 |    7 |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>而无论是使用触发器还是视图，对mysql的性能都会产生或多或少的影响，所以一般情况下，在生产环境中，建议是尽可能少的使用触发器和视图</p>
<ul>
<li>在MySQL5.7原生支持计算列语法</li>
</ul>
<p>在<code>create table</code>以及<code>alter table</code>语句中支持增加计算列</p>
<p><code>col_name data_type [GENERATED ALWAYS] AS (expression) [VIRTUAL|STORED] [UNIQUE [KEY]] [COMMENT comment] [[NOT] NULL] [[PRIMARY] KEY]</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop table t;</span><br><span class="line">Query OK, 0 rows affected (0.25 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table t (id int auto_increment not null, c1 int, c2 int, c3 int as (c1+c2), primary key(id));</span><br><span class="line">Query OK, 0 rows affected (0.22 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t;</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                                                                                                                                             |</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| t     | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`c1`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c2`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c3`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">GENERATED</span> <span class="keyword">ALWAYS</span> <span class="keyword">AS</span> ((<span class="string">`c1`</span> + <span class="string">`c2`</span>)) <span class="keyword">VIRTUAL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">insert</span> <span class="keyword">into</span> t(c1, c2) <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t;</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">|  1 |    1 |    2 |    3 |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">update</span> t <span class="keyword">set</span> c1=<span class="number">9</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t;</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">|  1 |    9 |    2 |   11 |</span><br><span class="line">+<span class="comment">----+------+------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>MySQL5.7原生支持的计算列有两种模式，一种是虚拟列，一种是存在磁盘中的列。虚拟列不占用磁盘空间</p>
<h2 id="引入了JSON列类型及相关的函数"><a href="#引入了JSON列类型及相关的函数" class="headerlink" title="引入了JSON列类型及相关的函数"></a>引入了JSON列类型及相关的函数</h2><ul>
<li>MySQL5.7之前，只能在varchar或是text等字符类型的列中存储json类型的字符串，并通过程序解析来使用json字符串</li>
<li>MySQL5.7之后，增加了json列类型以及<code>json_</code>开头的相关处理函数，如<code>json_type()``json_object()``json_merge()</code> 等</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个json的数组</span></span><br><span class="line">mysql&gt; select json_array('a','b',now());</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">| json_array('a','b',now())                |</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">| ["a", "b", "2016-08-21 02:41:45.000000"] |</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个json KV对象</span></span><br><span class="line">mysql&gt; <span class="keyword">select</span> json_object(<span class="string">'k1'</span>,<span class="number">1</span>,<span class="string">'k2'</span>,<span class="number">2</span>);</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| json_object('k1',1,'k2',2) |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| &#123;"k1": 1, "k2": 2&#125;         |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>创建一个含有json类型字段的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t1(jdoc json);</span><br><span class="line">Query OK, 0 rows affected (0.32 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                      |</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| t1    | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t1`</span> (</span><br><span class="line">  <span class="string">`jdoc`</span> <span class="keyword">json</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">insert</span> <span class="keyword">into</span> t1(jdoc) <span class="keyword">values</span>(json_array(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="keyword">now</span>()));</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t1(jdoc) values(json_object('k1',1,'k2',2));</span><br><span class="line">Query OK, 1 row affected (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t1;</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">| jdoc                                     |</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">| ["a", "b", "2016-08-21 02:47:50.000000"] |</span><br><span class="line">| &#123;"k1": 1, "k2": 2&#125;                       |</span><br><span class="line">+<span class="comment">------------------------------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>


<h1 id="REPLICATION方面的增强"><a href="#REPLICATION方面的增强" class="headerlink" title="REPLICATION方面的增强"></a>REPLICATION方面的增强</h1><h2 id="支持多源复制"><a href="#支持多源复制" class="headerlink" title="支持多源复制"></a>支持多源复制</h2><h2 id="基于库或是逻辑锁的多线程复制"><a href="#基于库或是逻辑锁的多线程复制" class="headerlink" title="基于库或是逻辑锁的多线程复制"></a>基于库或是逻辑锁的多线程复制</h2><h2 id="在线变更复制方式"><a href="#在线变更复制方式" class="headerlink" title="在线变更复制方式"></a>在线变更复制方式</h2><h1 id="InnoDB存储引擎的增强"><a href="#InnoDB存储引擎的增强" class="headerlink" title="InnoDB存储引擎的增强"></a>InnoDB存储引擎的增强</h1><h2 id="支持缓冲池大小在线变更"><a href="#支持缓冲池大小在线变更" class="headerlink" title="支持缓冲池大小在线变更"></a>支持缓冲池大小在线变更</h2><h2 id="增加innodb-buffer-pool导入导出功能"><a href="#增加innodb-buffer-pool导入导出功能" class="headerlink" title="增加innodb_buffer_pool导入导出功能"></a>增加innodb_buffer_pool导入导出功能</h2><h2 id="支持为innodb表建立表空间"><a href="#支持为innodb表建立表空间" class="headerlink" title="支持为innodb表建立表空间"></a>支持为innodb表建立表空间</h2><h1 id="MySQL安全方面的增强"><a href="#MySQL安全方面的增强" class="headerlink" title="MySQL安全方面的增强"></a>MySQL安全方面的增强</h1><h2 id="初始化数据库后的默认密码"><a href="#初始化数据库后的默认密码" class="headerlink" title="初始化数据库后的默认密码"></a>初始化数据库后的默认密码</h2><ul>
<li><p>在MySQL5.7之前的版本，初始化数据库后，默认的root密码为空，在localhost直接使用mysql客户端，可以以无密码的方式进入到数据库中</p>
</li>
<li><p>在MySQL5.7中，在初始化数据库之后，会为root生成一个强度为<code>大写字母+小写字母+数字+特殊符号</code>的密码，并且首次进入到mysql时，强制要你更改密码，且强度默认依然为<code>大写字母+小写字母+数字+特殊符号</code></p>
</li>
</ul>
<p>关于MySQL5.7的初始化密码的查找，可以参考本站的文章</p>
<ul>
<li><a href="https://docs.20150509.cn/2016/07/28/MySQL5-7初始密码/" target="_blank" rel="noopener">https://docs.20150509.cn/2016/07/28/MySQL5-7初始密码/</a></li>
</ul>
<h2 id="默认的密码强度"><a href="#默认的密码强度" class="headerlink" title="默认的密码强度"></a>默认的密码强度</h2><p>mysql对于密码有3种检验策略，默认validate_password_policy为MEDIUM</p>
<ul>
<li>LOW policy tests password length only. Passwords must be at least 8 characters long.</li>
<li>MEDIUM policy adds the conditions that passwords must contain at least 1 numeric character, 1 lowercase and uppercase character, and 1 special (nonalphanumeric) character.</li>
<li>STRONG policy adds the condition that password substrings of length 4 or longer must not match words</li>
</ul>
<p>关于MySQL5.7密码强度的更改，可以参考本站的文章</p>
<ul>
<li><a href="https://docs.20150509.cn/2016/08/19/CentOS7安装MySQL5-7/" target="_blank" rel="noopener">https://docs.20150509.cn/2016/08/19/CentOS7安装MySQL5-7/</a></li>
</ul>
<h2 id="不在支持old-password认证"><a href="#不在支持old-password认证" class="headerlink" title="不在支持old_password认证"></a>不在支持old_password认证</h2><h2 id="增加账号默认过期时间"><a href="#增加账号默认过期时间" class="headerlink" title="增加账号默认过期时间"></a>增加账号默认过期时间</h2><h2 id="加强了对账号的管理功能"><a href="#加强了对账号的管理功能" class="headerlink" title="加强了对账号的管理功能"></a>加强了对账号的管理功能</h2><h2 id="增加了sys管理数据库"><a href="#增加了sys管理数据库" class="headerlink" title="增加了sys管理数据库"></a>增加了sys管理数据库</h2>
      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/08/21/%E4%BF%AE%E6%94%B9MySQL%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/21/%E4%BF%AE%E6%94%B9MySQL%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/" class="post-title-link" itemprop="url">修改MySQL的字符集为utf8mb4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-21 10:22:10" itemprop="dateCreated datePublished" datetime="2016-08-21T10:22:10+08:00">2016-08-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/21/%E4%BF%AE%E6%94%B9MySQL%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%BAutf8mb4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/修改MySQL的字符集为utf8mb4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>一般情况下，我们会设置MySQL默认的字符编码为utf8，但是近些年来，emoji表情的火爆使用，给数据库带来了意外的错误，就是emoji的字符集已经超出了utf8的编码范畴😄</p>
</blockquote>
<h1 id="令人抓狂的字符编码问题"><a href="#令人抓狂的字符编码问题" class="headerlink" title="令人抓狂的字符编码问题"></a>令人抓狂的字符编码问题</h1><p>谈到字符编码问题，会让很多人感到头疼，这里不在深究各个字符编码的特点和理论，这里只说下Unicode和utf8字符编码的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Unicode是编码字符集，而UTF-8就是字符编码，即Unicode规则字库的一种实现形式。</span><br><span class="line">随着互联网的发展，对同一字库集的要求越来越迫切，Unicode标准也就自然而然的出现。</span><br><span class="line">它几乎涵盖了各个国家语言可能出现的符号和文字，并将为他们编号。</span><br><span class="line">详见：Unicode on Wikipedia。</span><br><span class="line">Unicode的编号从0000开始一直到10FFFF共分为16个Plane，每个Plane中有65536个字符。</span><br><span class="line">而UTF-8则只实现了第一个Plane，可见UTF-8虽然是一个当今接受度最广的字符集编码，</span><br><span class="line">但是它并没有涵盖整个Unicode的字库，这也造成了它在某些场景下对于特殊字符的处理困难</span><br></pre></td></tr></table></figure>

<p><strong>简单的说在计算机内存中，统一使用Unicode编码，当需要保存到硬盘或者需要传输的时候，就转换为UTF-8编码</strong></p>
<p>用记事本编辑的时候，从文件读取的UTF-8字符被转换为Unicode字符到内存里，编辑完成后，保存的时候再把Unicode转换为UTF-8保存到文件</p>
<p><img src="http://oss.20150509.cn/QQ20160821-0@2x.png" alt=""></p>
<p>emoji是Unicode编码，在MySQL中使用utf8编码无法正常显示emoji的表情，为了解决这个问题，MySQL在5.5.3版本之后，引进了新的字符编码<code>utf8mb4</code>,本篇文章主要介绍如何将已经是utf8的database切换到utf8mb4字符编码</p>
<h1 id="什么是utf8mb4"><a href="#什么是utf8mb4" class="headerlink" title="什么是utf8mb4"></a>什么是utf8mb4</h1><p>utf8mb4最明显的好处是解决了苹果挖的坑-推广了emoji表情。utf8mb4解决了MySQL数据库存储emoji表情的问题</p>
<p>utf8mb4是utf8的超集，理论上由utf8升级到utf8mb4字符编码没有任何兼容问题</p>
<h1 id="升级utf8到utf8mb4"><a href="#升级utf8到utf8mb4" class="headerlink" title="升级utf8到utf8mb4"></a>升级utf8到utf8mb4</h1><h2 id="1-备份"><a href="#1-备份" class="headerlink" title="1. 备份"></a>1. 备份</h2><p>安全第一，备份所有需要升级字符编码的数据库</p>
<ul>
<li>可以将库dump出来</li>
<li>如果是虚拟机，可以给整个主机做快照</li>
</ul>
<h2 id="2-升级"><a href="#2-升级" class="headerlink" title="2. 升级"></a>2. 升级</h2><p>utf8mb4是MySQL5.5.3版本之后支持的字符集，so，如果你需要使用这个字符集，前提条件是你的MySQL版本必须 &gt;= 5.5.3</p>
<h2 id="3-修改"><a href="#3-修改" class="headerlink" title="3. 修改"></a>3. 修改</h2><p>在MySQL中，可以为一个database设置字符编码，可以为一张表设置字符编码，甚至可以为某一个字段设置字符编码</p>
<ul>
<li>查看当前系统默认的字符集设置</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES WHERE Variable_name LIKE 'character\_set\_%' OR Variable_name LIKE 'collation%';</span><br><span class="line">+<span class="comment">--------------------------+-----------------+</span></span><br><span class="line">| Variable_name            | Value           |</span><br><span class="line">+<span class="comment">--------------------------+-----------------+</span></span><br><span class="line">| character_set_client     | utf8            |</span><br><span class="line">| character_set_connection | utf8            |</span><br><span class="line">| character_set_database   | utf8            |</span><br><span class="line">| character_set_filesystem | binary          |</span><br><span class="line">| character_set_results    | utf8            |</span><br><span class="line">| character_set_server     | utf8            |</span><br><span class="line">| character_set_system     | utf8            |</span><br><span class="line">| collation_connection     | utf8_general_ci |</span><br><span class="line">| collation_database       | utf8_general_ci |</span><br><span class="line">| collation_server         | utf8_general_ci |</span><br><span class="line">+<span class="comment">--------------------------+-----------------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看database的字符编码</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create database polarsnow;</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line">| Database  | <span class="keyword">Create</span> <span class="keyword">Database</span>                                                    |</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line">| polarsnow | <span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`polarsnow`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span> |</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看table的字符编码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table ps;</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------+</span><br><span class="line">| ps    | CREATE TABLE &#96;ps&#96; (</span><br><span class="line">  &#96;name&#96; varchar(100) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>查看column的字符编码</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show full columns from ps;</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| Field | Type         | Collation       | Null | Key | Default | Extra | Privileges                      | <span class="keyword">Comment</span> |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| <span class="keyword">name</span>  | <span class="built_in">varchar</span>(<span class="number">100</span>) | utf8_general_ci | YES  |     | <span class="literal">NULL</span>    |       | <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span> |         |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="修改database默认的字符集"><a href="#修改database默认的字符集" class="headerlink" title="修改database默认的字符集"></a>修改database默认的字符集</h3><p><code>ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER DATABASE polarsnow CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create database polarsnow;</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Database  | <span class="keyword">Create</span> <span class="keyword">Database</span>                                                                                  |</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| polarsnow | <span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`polarsnow`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */</span> |</span><br><span class="line">+<span class="comment">-----------+--------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">tables</span>;</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| Tables_in_polarsnow |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| ps                  |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> ps;</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                |</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line">| ps    | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ps`</span> (</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 |</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">columns</span> <span class="keyword">from</span> ps;</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| Field | Type         | Collation       | Null | Key | Default | Extra | Privileges                      | <span class="keyword">Comment</span> |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| <span class="keyword">name</span>  | <span class="built_in">varchar</span>(<span class="number">100</span>) | utf8_general_ci | YES  |     | <span class="literal">NULL</span>    |       | <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span> |         |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">create</span> <span class="keyword">table</span> test_tb2 (tb2 <span class="built_in">varchar</span>(<span class="number">100</span>) );</span><br><span class="line">Query OK, 0 rows affected (0.21 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| Tables_in_polarsnow |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">| ps                  |</span><br><span class="line">| test_tb2            |</span><br><span class="line">+<span class="comment">---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> test_tb2;</span><br><span class="line">+<span class="comment">----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table    | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                              |</span><br><span class="line">+<span class="comment">----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| test_tb2 | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test_tb2`</span> (</span><br><span class="line">  <span class="string">`tb2`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，虽然修改了database的字符集为utf8mb4，但是实际只是修改了database新创建的表，默认使用utf8mb4，原来已经存在的表，字符集并没有跟着改变，需要手动为每张表设置字符集</p>
<h3 id="修改table的字符集"><a href="#修改table的字符集" class="headerlink" title="修改table的字符集"></a>修改table的字符集</h3><ul>
<li>只修改表默认的字符集 <code>ALTER TABLE table_name DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></li>
<li>修改表默认的字符集和所有字符列的字符集 <code>ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table ps;</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                |</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line">| ps    | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ps`</span> (</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 |</span><br><span class="line">+<span class="comment">-------+---------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">columns</span> <span class="keyword">from</span> ps;</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| Field | Type         | Collation       | Null | Key | Default | Extra | Privileges                      | <span class="keyword">Comment</span> |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| <span class="keyword">name</span>  | <span class="built_in">varchar</span>(<span class="number">100</span>) | utf8_general_ci | YES  |     | <span class="literal">NULL</span>    |       | <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span> |         |</span><br><span class="line">+<span class="comment">-------+--------------+-----------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> ps <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line">Query OK, 0 rows affected (0.38 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table ps;</span><br><span class="line">+<span class="comment">-------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                         |</span><br><span class="line">+<span class="comment">-------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| ps    | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ps`</span> (</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8mb4_unicode_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">-------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">columns</span> <span class="keyword">from</span> ps;</span><br><span class="line">+<span class="comment">-------+--------------+--------------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| Field | Type         | Collation          | Null | Key | Default | Extra | Privileges                      | <span class="keyword">Comment</span> |</span><br><span class="line">+<span class="comment">-------+--------------+--------------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line">| <span class="keyword">name</span>  | <span class="built_in">varchar</span>(<span class="number">100</span>) | utf8mb4_unicode_ci | YES  |     | <span class="literal">NULL</span>    |       | <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span> |         |</span><br><span class="line">+<span class="comment">-------+--------------+--------------------+------+-----+---------+-------+---------------------------------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修改column默认的字符集"><a href="#修改column默认的字符集" class="headerlink" title="修改column默认的字符集"></a>修改column默认的字符集</h3><p><code>ALTER TABLE table_name CHANGE column_name column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></p>
<p><em>注：VARCHAR(191) 根据字段实例的类型填写</em></p>
<h2 id="4-检查字段的最大长度和索引列"><a href="#4-检查字段的最大长度和索引列" class="headerlink" title="4. 检查字段的最大长度和索引列"></a>4. 检查字段的最大长度和索引列</h2><ul>
<li>字段长度</li>
</ul>
<p>由于从utf8升级到了utf8mb4，一个字符所占用的空间也由3个字节增长到4个字节，但是我们当初创建表时，设置的字段类型以及最大的长度没有改变。例如，你在utf8下设置某一字段的类型为<code>TINYTEXT</code>, 这中字段类型最大可以容纳255字节，三个字节一个字符的情况下可以容纳85个字符，四个字节一个字符的情况下只能容纳63个字符，如果原表中的这个字段的值有一个或多个超过了63个字符，那么转换成utf8mb4字符编码时将转换失败，你必须先将<code>TINYTEXT</code>更改为<code>TEXT</code>等更高容量的类型之后才能继续转换字符编码</p>
<ul>
<li>索引</li>
</ul>
<p>在InnoDB引擎中，最大的索引长度为767字节，三个字节一个字符的情况下，索引列的字符长度最大可以达到255，四个字节一个字符的情况下，索引的字符长度最大只能到191。如果你已经存在的表中的索引列的类型为<code>VARCHAR(255)</code>那么转换utf8mb4时同样会转换失败。你需要先将<code>VARCHAR(255)</code>更改为<code>VARCHAR(191)</code>才能继续转换字符编码</p>
<h2 id="5-修改配置文件"><a href="#5-修改配置文件" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h2><p><code>SET NAMES utf8 COLLATE utf8_unicode_ci</code> becomes <code>SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; vim /etc/my.cnf</span><br><span class="line"><span class="comment"># 对本地的mysql客户端的配置</span></span><br><span class="line">[client]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对其他远程连接的mysql客户端的配置</span></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地mysql服务的配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">character-set-client-handshake = FALSE</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_unicode_ci</span><br><span class="line">&gt; service mysqld restart</span><br></pre></td></tr></table></figure>

<p>检查修改</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES WHERE Variable_name LIKE 'character\_set\_%' OR Variable_name LIKE 'collation%';</span><br><span class="line">+<span class="comment">--------------------------+--------------------+</span></span><br><span class="line">| Variable_name            | Value              |</span><br><span class="line">+<span class="comment">--------------------------+--------------------+</span></span><br><span class="line">| character_set_client     | utf8mb4            |</span><br><span class="line">| character_set_connection | utf8mb4            |</span><br><span class="line">| character_set_database   | utf8mb4            |</span><br><span class="line">| character_set_filesystem | binary             |</span><br><span class="line">| character_set_results    | utf8mb4            |</span><br><span class="line">| character_set_server     | utf8mb4            |</span><br><span class="line">| character_set_system     | utf8               |</span><br><span class="line">| collation_connection     | utf8mb4_unicode_ci |</span><br><span class="line">| collation_database       | utf8mb4_unicode_ci |</span><br><span class="line">| collation_server         | utf8mb4_unicode_ci |</span><br><span class="line">+<span class="comment">--------------------------+--------------------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><em>注：character_set_system 一直都会是 utf8，不能被更改</em></p>
<h2 id="6-修复-amp-优化所有数据表"><a href="#6-修复-amp-优化所有数据表" class="headerlink" title="6. 修复&amp;优化所有数据表"></a>6. 修复&amp;优化所有数据表</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; mysqlcheck -u root -p --auto-repair --optimize --all-databases</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>不要在MySQL上使用utf8字符编码，推荐使用<code>utf8mb4</code>，至于为什么，引用国外友人的一段话：</p>
<blockquote>
<p>Never use utf8 in MySQL — always use utf8mb4 instead. Updating your databases and code might take some time, but it’s definitely worth the effort. Why would you arbitrarily limit the set of symbols that can be used in your database? Why would you lose data every time a user enters an astral symbol as part of a comment or message or whatever it is you store in your database? There’s no reason not to strive for full Unicode support everywhere. Do the right thing, and use utf8mb4. 🍻</p>
</blockquote>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li>字符集和字符编码的关系：<a href="http://www.cnblogs.com/cenalulu/p/4251639.html" target="_blank" rel="noopener">http://www.cnblogs.com/cenalulu/p/4251639.html</a></li>
<li>让mysql支持utf8mb4：<a href="https://mathiasbynens.be/notes/mysql-utf8mb4" target="_blank" rel="noopener">https://mathiasbynens.be/notes/mysql-utf8mb4</a></li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/08/19/MySQL5-7%E7%A6%BB%E7%BA%BF%E6%9B%B4%E6%94%B9%E4%B8%BA%E4%BA%8B%E5%8A%A1%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/19/MySQL5-7%E7%A6%BB%E7%BA%BF%E6%9B%B4%E6%94%B9%E4%B8%BA%E4%BA%8B%E5%8A%A1%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">MySQL5.7离线更改为事务复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-19 22:45:21" itemprop="dateCreated datePublished" datetime="2016-08-19T22:45:21+08:00">2016-08-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/19/MySQL5-7%E7%A6%BB%E7%BA%BF%E6%9B%B4%E6%94%B9%E4%B8%BA%E4%BA%8B%E5%8A%A1%E5%A4%8D%E5%88%B6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/19/MySQL5-7离线更改为事务复制/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>从MySQL5.6版本开始，支持以事务的方式来做主从同步，最大限度的保证MySQL的主从一致性。实现这一复制特性的关键是GTID(Global Transaction Identifiers)全局事务ID，通过GTID来强化数据库的主从一致性，故障恢复以及容错能力</p>
<p>MySQL5.7支持在线修改复制类型，MySQL5.6只能离线修改，本篇文章主要介绍离线修改复制类型的方法，后续的文章中会介绍如何在线更换复制类型</p>
</blockquote>
<h1 id="什么是GTID"><a href="#什么是GTID" class="headerlink" title="什么是GTID"></a>什么是GTID</h1><p>官方文档：</p>
<ul>
<li>5.6: <a href="http://dev.mysql.com/doc/refman/5.6/en/replication-gtids.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.6/en/replication-gtids.html</a></li>
<li>5.7: <a href="http://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html</a></li>
</ul>
<p>A GTID is represented as a pair of coordinates, separated by a colon character (:), as shown here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GTID &#x3D; source_id:transaction_id</span><br></pre></td></tr></table></figure>

<p>每一个 GTID 代表一个数据库事务。在上面的定义中，<code>source_id</code> 表示执行事务的主库 uuid（server_uuid），<code>transaction_id</code> 是一个从 1 开始的自增计数，表示在这个主库上执行的第 n 个事务。MySQL 会保证事务与 GTID 之间的 1 : 1 映射</p>
<h1 id="服务器资源"><a href="#服务器资源" class="headerlink" title="服务器资源"></a>服务器资源</h1><ul>
<li>master：192.168.10.153</li>
<li>slave：192.168.10.157</li>
</ul>
<h1 id="安装MySQL5-7"><a href="#安装MySQL5-7" class="headerlink" title="安装MySQL5.7"></a>安装MySQL5.7</h1><p>略</p>
<p>可以参考上一篇文章来安装MySQL5.7</p>
<h1 id="master配置"><a href="#master配置" class="headerlink" title="master配置"></a>master配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&gt; vim /etc/my.cnf</span><br><span class="line"><span class="comment"># client的配置会被MySQL客户端应用读取</span></span><br><span class="line"><span class="comment"># 只有MySQL附带的客户端应用程序保证可以读取到这段内容</span></span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line"><span class="comment"># 生产环境中所使用的字符集推荐设置为utf8mb4</span></span><br><span class="line"><span class="comment"># 这里默认使用utf8，字符集的问题将有独立的文章介绍</span></span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端读取的配置文件</span></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line"><span class="comment"># 生产环境中所使用的字符集推荐设置为utf8mb4</span></span><br><span class="line"><span class="comment"># 这里默认使用utf8，字符集的问题将有独立的文章介绍</span></span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL服务端读取的配置文件</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 10153  <span class="comment"># 保证server-id的唯一性，这里采用了IP的后两位来保证唯一性</span></span><br><span class="line">port = 3306 <span class="comment"># MySQL服务监听的端口号</span></span><br><span class="line">user = mysql <span class="comment"># 以mysql用户来运行MySQL服务进程</span></span><br><span class="line">basedir = /usr/<span class="built_in">local</span>/mysql <span class="comment"># MySQL服务的根目录（编译安装指定路径，yum安装注释掉即可）</span></span><br><span class="line">datadir = /data/mysqldata <span class="comment"># 数据目录</span></span><br><span class="line">socket = /tmp/mysql.sock <span class="comment"># socket文件所在的位置</span></span><br><span class="line">default-storage-engine = INNODB <span class="comment"># 默认的存储引擎</span></span><br><span class="line"><span class="comment"># 生产环境中所使用的字符集推荐设置为utf8mb4</span></span><br><span class="line"><span class="comment"># 这里默认使用utf8，字符集的问题将有独立的文章介绍</span></span><br><span class="line">character-set-server = utf8</span><br><span class="line">connect_timeout = 60 <span class="comment"># 连接超时时间</span></span><br><span class="line">interactive_timeout = 28800 <span class="comment"># MySQL在关闭一个交互的连接之前所要等待的秒数(交互连接如mysql gui tool中的连接)</span></span><br><span class="line">wait_timeout = 28800 <span class="comment"># MySQL在关闭一个非交互的连接之前所要等待的秒数</span></span><br><span class="line">back_log = 500 <span class="comment"># 操作系统在监听队列中所能保持的连接数</span></span><br><span class="line">event_scheduler = ON <span class="comment"># 开启定时任务机制</span></span><br><span class="line">skip_name_resolve = ON <span class="comment"># 忽略IP方向解析</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###########binlog##########</span></span><br><span class="line"><span class="built_in">log</span>-bin = /data/mysqlLog/logs/mysql-bin <span class="comment"># 打开二进制日志功能</span></span><br><span class="line"><span class="comment"># 当设置隔离级别为READ-COMMITED必须设置二进制日志格式为ROW</span></span><br><span class="line"><span class="comment"># 现在MySQL官方认为STATEMENT这个已经不再适合继续使用</span></span><br><span class="line"><span class="comment"># 但mixed类型在默认的事务隔离级别下，可能会导致主从数据不一致</span></span><br><span class="line">binlog_format = row <span class="comment"># 复制模式为行级模式（复制模式的介绍可以参考本站关于复制基础的文章）</span></span><br><span class="line">max_binlog_size = 128M <span class="comment"># 每个二进制日志最大的文件大小</span></span><br><span class="line">binlog_cache_size = 2M <span class="comment"># 二进制日志缓存大小</span></span><br><span class="line">expire-logs-days = 5 <span class="comment"># 二进制日志的保存时间（保存最近5天的二进制日志）</span></span><br><span class="line"><span class="comment"># 将slave在master收到的更新记入到slave自己的二进制日志文件中</span></span><br><span class="line"><span class="comment"># 在MySQL级联复制中，这个参数必须打开（A=&gt;B=&gt;C）</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates=<span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下三个参数启用复制有关的所有校验功能</span></span><br><span class="line">binlog_checksum = CRC32 <span class="comment"># checksum使用zlib中的CRC-32算法</span></span><br><span class="line"><span class="comment"># 不仅dump thread会对event进行校验，当master上执行show binlog events的时候</span></span><br><span class="line"><span class="comment"># 也会对event进行校验</span></span><br><span class="line"><span class="comment"># 设置为1，可以保证event被完整无缺地写入到主服务器的binlog中了</span></span><br><span class="line">master_verify_checksum = 1 </span><br><span class="line">slave_sql_verify_checksum = 1 <span class="comment"># 设置为1，slave上的IO Thread写入到Relay Log时和SQL Thread读取Relay Log时会对checksum进行验证</span></span><br><span class="line"></span><br><span class="line">binlog_rows_query_log_events = 1 <span class="comment"># 可用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### GTID事务复制支持部分 ######</span></span><br><span class="line">gtid-mode=on <span class="comment"># 开启全局事务ID</span></span><br><span class="line">enforce-gtid-consistency=<span class="literal">true</span> <span class="comment"># 开启强制全局事务ID一致性（用于启动GTID及满足附属的其它需求）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用此两项，可用于实现在崩溃时保证二进制及从服务器安全的功能</span></span><br><span class="line">master-info-repository=TABLE </span><br><span class="line">relay-log-info-repository=TABLE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sync-master-info=1 <span class="comment"># 确保无信息丢失</span></span><br><span class="line">slave-parallel-workers=4 <span class="comment"># 设定从服务器的SQL线程数；0表示关闭多线程复制功能</span></span><br><span class="line"><span class="comment"># rpl_semi_sync_master_enabled = 1 # 半同步复制</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 慢SQL的相关配置</span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/mysqlLog/logs/mysql.slow</span><br><span class="line">long_query_time = 1</span><br><span class="line"> </span><br><span class="line">log_error = /data/mysqlLog/logs/error.log <span class="comment"># 错误信息的配置</span></span><br><span class="line">max_connections = 3000 <span class="comment"># MySQL的最大连接数</span></span><br><span class="line">max_connect_errors = 32767 <span class="comment"># 某一客户端尝试连接此MySQL服务器，但是失败（如密码错误等等）32767次，则MySQL会无条件强制阻止此客户端连接</span></span><br><span class="line">log_bin_trust_function_creators = 1 <span class="comment"># 允许使用MySQL自定义函数</span></span><br><span class="line">transaction_isolation = READ-COMMITTED <span class="comment"># 设置事务隔离级别</span></span><br></pre></td></tr></table></figure>

<h1 id="slave配置"><a href="#slave配置" class="headerlink" title="slave配置"></a>slave配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&gt; vim /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 10157</span><br><span class="line">port = 3306</span><br><span class="line">user = mysql</span><br><span class="line">basedir = /usr/<span class="built_in">local</span>/mysql</span><br><span class="line">datadir = /data/mysqldata</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">default-storage-engine = INNODB</span><br><span class="line">character-set-server = utf8</span><br><span class="line">connect_timeout = 60</span><br><span class="line">wait_timeout = 18000</span><br><span class="line">back_log = 500</span><br><span class="line">event_scheduler = ON</span><br><span class="line"> </span><br><span class="line"><span class="comment">###########binlog##########</span></span><br><span class="line"><span class="built_in">log</span>-bin = /data/mysqlLog/logs/mysql-bin</span><br><span class="line">binlog_format = row</span><br><span class="line">max_binlog_size = 128M</span><br><span class="line">binlog_cache_size = 2M</span><br><span class="line">expire-logs-days = 5</span><br><span class="line"><span class="built_in">log</span>-slave-updates=<span class="literal">true</span></span><br><span class="line">gtid-mode=on </span><br><span class="line">enforce-gtid-consistency=<span class="literal">true</span></span><br><span class="line">master-info-repository=TABLE</span><br><span class="line">relay-log-info-repository=TABLE</span><br><span class="line">sync-master-info=1</span><br><span class="line">slave-parallel-workers=4</span><br><span class="line"><span class="comment"># rpl_semi_sync_slave_enabled = 1</span></span><br><span class="line"><span class="comment"># skip-slave-start # slave复制进程不随mysql启动而启动</span></span><br><span class="line"></span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/mysqlLog/logs/mysql.slow</span><br><span class="line">long_query_time = 2</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>-error = /data/mysqlLog/logs/error.log</span><br><span class="line">max_connections = 3000</span><br><span class="line">max_connect_errors = 10000</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br></pre></td></tr></table></figure>

<h1 id="分别启动主库和从库"><a href="#分别启动主库和从库" class="headerlink" title="分别启动主库和从库"></a>分别启动主库和从库</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h1 id="在主库中创建复制用户"><a href="#在主库中创建复制用户" class="headerlink" title="在主库中创建复制用户"></a>在主库中创建复制用户</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL validate_password_policy = LOW;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user 'repl' identified by '12345678';</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant replication slave on *.* to repl@'%';</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>

<h1 id="查看主库与从库GTID状态"><a href="#查看主库与从库GTID状态" class="headerlink" title="查看主库与从库GTID状态"></a>查看主库与从库GTID状态</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'gtid_mode';</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| gtid_mode     | ON    |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h1 id="在从库启动复制线程"><a href="#在从库启动复制线程" class="headerlink" title="在从库启动复制线程"></a>在从库启动复制线程</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to</span><br><span class="line">    -&gt;   master_host='192.168.10.153',</span><br><span class="line">    -&gt;   master_port=3306,</span><br><span class="line">    -&gt;   master_user='repl',</span><br><span class="line">    -&gt;   master_password='12345678',</span><br><span class="line">    -&gt;   master_auto_position=1 for channel "db153";</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.27 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave for channel "db153";</span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status for channel "db153" \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.10.153</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 595</span><br><span class="line">               Relay_Log_File: localhost-relay-bin-db153.000002</span><br><span class="line">                Relay_Log_Pos: 808</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 595</span><br><span class="line">              Relay_Log_Space: 1025</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 10153</span><br><span class="line">                  Master_UUID: 1349d343-6611-11e6-b341-005056ad5f2f</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 1349d343-6611-11e6-b341-005056ad5f2f:1-2</span><br><span class="line">            Executed_Gtid_Set: 1349d343-6611-11e6-b341-005056ad5f2f:1-2</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: db153</span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h1 id="验证主从同步"><a href="#验证主从同步" class="headerlink" title="验证主从同步"></a>验证主从同步</h1><h2 id="master"><a href="#master" class="headerlink" title="master"></a>master</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">| mysql-bin.000001 |      595 |              |                  | 1349d343-6611-11e6-b341-005056ad5f2f:1-2 |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">create</span> <span class="keyword">database</span> polarsnow;</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">| mysql-bin.000001 |      769 |              |                  | 1349d343-6611-11e6-b341-005056ad5f2f:1-3 |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+------------------+------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h2 id="slave"><a href="#slave" class="headerlink" title="slave"></a>slave</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status for channel "db153"\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.10.153</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 769</span><br><span class="line">               Relay_Log_File: localhost-relay-bin-db153.000002</span><br><span class="line">                Relay_Log_Pos: 982</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 769</span><br><span class="line">              Relay_Log_Space: 1199</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 10153</span><br><span class="line">                  Master_UUID: 1349d343-6611-11e6-b341-005056ad5f2f</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 1349d343-6611-11e6-b341-005056ad5f2f:1-3</span><br><span class="line">            Executed_Gtid_Set: 1349d343-6611-11e6-b341-005056ad5f2f:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: db153</span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| polarsnow          |</span><br><span class="line">| sys                |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>至此，事务同步配置成功！</p>
<p>在之前使用二进制复制的主从模式时，经历了各种主从数据不一致的情况，而从MySQL5.6开始新引入的事务复制能否解决二进制bin-log复制的数据一致性的痛点还有待观察和检验……</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><ul>
<li>MySQL5.7官方文档：<a href="http://dev.mysql.com/doc/refman/5.7/en/" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.7/en/</a></li>
<li>参考文档：<a href="http://www.cnblogs.com/darren-lee/p/5160802.html" target="_blank" rel="noopener">http://www.cnblogs.com/darren-lee/p/5160802.html</a></li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://docs.lvrui.io/2016/08/19/CentOS7%E5%AE%89%E8%A3%85MySQL5-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.JPG">
      <meta itemprop="name" content="极地瑞雪">
      <meta itemprop="description" content="极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Polar Snow Documentation">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/19/CentOS7%E5%AE%89%E8%A3%85MySQL5-7/" class="post-title-link" itemprop="url">CentOS7安装MySQL5.7</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-19 21:29:52" itemprop="dateCreated datePublished" datetime="2016-08-19T21:29:52+08:00">2016-08-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/08/19/CentOS7%E5%AE%89%E8%A3%85MySQL5-7/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/19/CentOS7安装MySQL5-7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>这里使用yum的方式安装mysql5.7，仅为测试使用，生产环境中，还是建议使用cmake编译安装mysql    </p>
</blockquote>
<h1 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&gt; yum remove -y mysql</span><br><span class="line">&gt; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">&gt; wget http://repo.mysql.com/mysql57-community-release-el7-8.noarch.rpm</span><br><span class="line">&gt; rpm -ivh mysql57-community-release-el7-8.noarch.rpm </span><br><span class="line">警告：mysql57-community-release-el7-8.noarch.rpm: 头V3 DSA/SHA1 Signature, 密钥 ID 5072e1f5: NOKEY</span><br><span class="line">准备中...                          <span class="comment">################################# [100%]</span></span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:mysql57-community-release-el7-8  <span class="comment">################################# [100%]</span></span><br><span class="line">&gt; yum install -y mysql-server</span><br><span class="line">&gt; systemctl start mysqld</span><br><span class="line">&gt; systemctl status mysqld</span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 五 2016-08-19 09:30:24 EDT; 29s ago</span><br><span class="line">  Process: 105136 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class="variable">$MYSQLD_OPTS</span> (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 105049 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 105138 (mysqld)</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─105138 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">8月 19 09:30:16 localhost.localdomain systemd[1]: Starting MySQL Server...</span><br><span class="line">8月 19 09:30:24 localhost.localdomain systemd[1]: Started MySQL Server.</span><br><span class="line">&gt; cat /var/<span class="built_in">log</span>/mysqld.log| grep <span class="string">"temporary password"</span></span><br><span class="line">2016-08-19T13:30:20.547835Z 1 [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: TVu7ouUi&gt;55l</span><br><span class="line">&gt; mysql -uroot -p</span><br><span class="line">Enter password:TVu7ouUi&gt;55l</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.7.14</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h1 id="设置root用户密码"><a href="#设置root用户密码" class="headerlink" title="设置root用户密码"></a>设置root用户密码</h1><p>MySQL5.7默认的密码复杂度为：大小写字母+数字+特殊符号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter user user() identified by 'w&#123;YQW6L;Dsf6vw';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE 'validate_password%';</span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">| Variable_name                        | Value  |</span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">| validate_password_dictionary_file    |        |</span><br><span class="line">| validate_password_length             | 8      |</span><br><span class="line">| validate_password_mixed_case_count   | 1      |</span><br><span class="line">| validate_password_number_count       | 1      |</span><br><span class="line">| validate_password_policy             | MEDIUM |</span><br><span class="line">| validate_password_special_char_count | 1      |</span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>mysql对于密码有3种检验策略，默认<code>validate_password_policy</code>为<code>MEDIUM</code></p>
<ul>
<li>LOW policy tests password length only. Passwords must be at least 8 characters long.</li>
<li>MEDIUM policy adds the conditions that passwords must contain at least 1 numeric character, 1 lowercase and uppercase character, and 1 special (nonalphanumeric) character.</li>
<li>STRONG policy adds the condition that password substrings of length 4 or longer must not match words</li>
</ul>
<p>在默认<code>MEDIUM</code>的策略下，修改密码为：12345678会报错</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter user user() identified by '12345678';</span><br><span class="line">ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</span><br></pre></td></tr></table></figure>

<h1 id="修改MySQL密码检查策略"><a href="#修改MySQL密码检查策略" class="headerlink" title="修改MySQL密码检查策略"></a>修改MySQL密码检查策略</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL validate_password_policy = LOW;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; alter user user() identified by '12345678';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="极地瑞雪"
      src="/images/avatar.JPG">
  <p class="site-author-name" itemprop="name">极地瑞雪</p>
  <div class="site-description" itemprop="description">极地瑞雪的个人技术博客. "取之开源 用之开源", 分享自己的经验之谈".</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">288</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">379</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Larry0315" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Larry0315" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:polarsnow@lvrui.io" title="E-Mail → mailto:polarsnow@lvrui.io" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.lvrui.io/" title="https:&#x2F;&#x2F;www.lvrui.io" rel="noopener" target="_blank">www.lvrui.io</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://20150509.cn/" title="https:&#x2F;&#x2F;20150509.cn" rel="noopener" target="_blank">20150509.cn</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">冀ICP备15013857号-2 </a>
  </div>

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">极地瑞雪</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://polarsnow.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
